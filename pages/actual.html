---
layout: default
title: Actual Deck
permalink: /actual/
---

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Actual Deck</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root {
    color-scheme: light;
    font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    --surface: #f6f1ea;
  }

  body {
    background: var(--surface);
  }

  main {
    position: relative;
  }

  .card {
    perspective: 1600px;
  }

  .card-inner {
    position: relative;
    transform-style: preserve-3d;
    transition: transform .6s ease;
  }

  .card[data-flipped="1"] .card-inner {
    transform: rotateY(180deg);
  }

  .card-surface {
    position: relative;
    backface-visibility: hidden;
    border-radius: 1.5rem;
    padding: 1.75rem;
    min-height: 16rem;
    border: 3px solid color-mix(in oklab, var(--card-color, #CBD5E1) 55%, #0f172a 45%);
    background: #fff;
    box-shadow: 12px 12px 0 rgba(15, 23, 42, 0.12);
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .card-front {
    background: #fff;
  }

  .card-back {
    background: color-mix(in oklab, var(--card-color, #E2E8F0) 30%, #fff 70%);
  }

  .face.back {
    transform: rotateY(180deg);
    position: absolute;
    inset: 0;
  }

  .card[data-in-stack="1"] .card-surface {
    box-shadow: 16px 16px 0 rgba(14, 165, 233, 0.25);
  }

  .card[data-highlight="1"] .card-surface {
    outline: 4px solid rgba(14, 165, 233, 0.7);
    outline-offset: -4px;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
  }

  .type-ribbon {
    display: inline-flex;
    align-items: center;
    gap: .5rem;
    padding: .4rem 1rem;
    border-radius: 9999px;
    text-transform: uppercase;
    font-size: .7rem;
    font-weight: 700;
    letter-spacing: .14em;
    color: #0f172a;
    background: color-mix(in oklab, var(--card-color, #c7d2fe) 40%, #fff 60%);
    border: 1px solid color-mix(in oklab, var(--card-color, #a5b4fc) 55%, #0f172a 45%);
  }

  .card-controls {
    display: flex;
    gap: .5rem;
    flex-wrap: wrap;
  }

  .flip-btn,
  .stack-btn,
  .dialog-btn,
  .stack-panel button {
    border-radius: 9999px;
    border: 2px solid #1e293b;
    padding: .3rem .9rem;
    background: #fff;
    font-size: .75rem;
    font-weight: 600;
    letter-spacing: .04em;
    text-transform: uppercase;
    color: #1e293b;
    transition: transform .15s ease, box-shadow .15s ease;
    cursor: pointer;
  }

  .flip-btn:hover,
  .stack-btn:hover,
  .dialog-btn:hover,
  .stack-panel button:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 12px rgba(15, 23, 42, 0.1);
  }

  .stack-btn[data-active="1"] {
    background: color-mix(in oklab, var(--card-color, #c7d2fe) 55%, #fff 45%);
  }

  .card-front-body {
    display: grid;
    gap: 1.5rem;
    align-items: stretch;
  }

  @media (min-width: 520px) {
    .card-front-body {
      grid-template-columns: minmax(0, .42fr) minmax(0, .58fr);
    }
  }

  .card-illustration {
    position: relative;
    border-radius: 1.25rem;
    border: 2px solid color-mix(in oklab, var(--card-color, #c7d2fe) 55%, #1e293b 45%);
    background: color-mix(in oklab, var(--card-color, #dbeafe) 55%, #fff 45%);
    min-height: 12rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: clamp(2.5rem, 8vw, 3.5rem);
    font-weight: 700;
    color: #0f172a;
    text-transform: uppercase;
    overflow: hidden;
  }

  .card-front-content {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .card-title {
    font-size: clamp(1.35rem, 4vw, 1.8rem);
    font-weight: 700;
    color: #0f172a;
  }

  .card-summary {
    font-size: .98rem;
    line-height: 1.65;
    color: #1e293b;
  }

  .card-quote {
    position: relative;
    padding-left: 1.25rem;
    color: #0f172a;
    font-style: italic;
  }

  .card-quote::before {
    content: "“";
    font-size: 2.25rem;
    position: absolute;
    left: 0;
    top: -.75rem;
    color: color-mix(in oklab, var(--card-color, #c7d2fe) 70%, #0f172a 30%);
  }

  .card-author {
    font-size: .85rem;
    color: #475569;
  }

  .card-footer {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: .75rem;
  }

  .card-id {
    font-size: .75rem;
    letter-spacing: .08em;
    text-transform: uppercase;
    color: #475569;
  }

  .card-footer .card-id {
    margin-left: auto;
  }

  .tag-list {
    display: flex;
    flex-wrap: wrap;
    gap: .4rem;
  }

  .tag {
    background: color-mix(in oklab, var(--card-color, #dbeafe) 45%, #fff 55%);
    border: 1px solid color-mix(in oklab, var(--card-color, #c7d2fe) 55%, #1e293b 45%);
    border-radius: 9999px;
    padding: .2rem .75rem;
    font-size: .72rem;
    font-weight: 600;
    color: #0f172a;
    cursor: pointer;
    transition: transform .15s ease, box-shadow .15s ease;
  }

  .tag:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 10px rgba(15, 23, 42, 0.12);
  }

  .card-back h3.card-back-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: #0f172a;
  }

  .card-back-body {
    display: flex;
    flex-direction: column;
    gap: .75rem;
  }

  .card-section {
    margin-top: 1rem;
  }

  .card-section-title {
    font-size: .75rem;
    text-transform: uppercase;
    letter-spacing: .16em;
    color: #1e293b;
    font-weight: 700;
    margin-bottom: .55rem;
  }

  .card-section-list {
    list-style: decimal;
    padding-left: 1.25rem;
    color: #0f172a;
    line-height: 1.6;
  }

  .card-section-text {
    color: #0f172a;
    line-height: 1.6;
  }

  .card-empty-note {
    font-size: .9rem;
    color: #64748b;
    font-style: italic;
  }

  .stack-panel {
    border: 2px solid #1e293b;
    border-radius: 1.5rem;
    padding: 1.5rem;
    background: #fffef9;
    box-shadow: 10px 10px 0 rgba(15, 23, 42, 0.08);
  }

  .stack-card {
    border-radius: 1rem;
    border: 2px solid color-mix(in oklab, var(--card-color, #dbeafe) 55%, #1e293b 45%);
    background: color-mix(in oklab, var(--card-color, #f1f5f9) 60%, #fff 40%);
    padding: .85rem;
    display: flex;
    gap: .85rem;
    align-items: flex-start;
  }

  .stack-card button {
    padding: .25rem .45rem;
    border-radius: .5rem;
    border: 2px solid #1e293b;
    background: #fff;
    font-size: .65rem;
    letter-spacing: .08em;
    text-transform: uppercase;
    font-weight: 600;
  }

  .stack-card button:disabled {
    opacity: .35;
    cursor: not-allowed;
  }

  .stack-card-main {
    flex: 1;
    cursor: pointer;
  }

  .stack-card-actions {
    display: flex;
    flex-direction: column;
    gap: .35rem;
  }

  .stack-meta {
    font-size: .75rem;
    color: #475569;
    text-transform: uppercase;
    letter-spacing: .08em;
  }

  .stack-empty {
    font-size: .85rem;
    color: #475569;
    font-style: italic;
  }

  .presentation-overlay {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(15, 23, 42, 0.82);
    z-index: 50;
    padding: 1.5rem;
  }

  .presentation-overlay[hidden] {
    display: none;
  }

  .presentation-dialog {
    background: #fffaf3;
    border-radius: 1.5rem;
    width: 100%;
    max-width: 48rem;
    max-height: 100%;
    padding: 2rem;
    box-shadow: 0 25px 50px rgba(15, 23, 42, 0.45);
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .presentation-card {
    flex: 1;
    overflow: auto;
  }

  .presentation-controls {
    display: flex;
    gap: .75rem;
    justify-content: space-between;
    flex-wrap: wrap;
  }

  .presentation-face {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    border-radius: 1.5rem;
    border: 3px solid color-mix(in oklab, var(--card-color, #CBD5E1) 55%, #0f172a 45%);
    background: #fff;
    padding: 1.75rem;
    box-shadow: 12px 12px 0 rgba(15, 23, 42, 0.12);
  }

  .presentation-face.back {
    background: color-mix(in oklab, var(--card-color, #E2E8F0) 35%, #fff 65%);
  }

  .dialog-btn {
    border-radius: .75rem;
  }

  .card-back .card-section-list,
  .presentation-face .card-section-list {
    list-style: decimal;
  }

  .card-back .card-section-list li,
  .presentation-face .card-section-list li {
    margin-bottom: .45rem;
  }

  .card-back .card-section-text,
  .presentation-face .card-section-text {
    font-size: .95rem;
  }

  .tag:focus-visible,
  .flip-btn:focus-visible,
  .stack-btn:focus-visible,
  .dialog-btn:focus-visible,
  .stack-panel button:focus-visible {
    outline: 3px solid #2563eb;
    outline-offset: 2px;
  }
  .stack-btn {
    border:1px solid #CBD5E1; padding:.25rem .5rem; border-radius:.5rem; font-size:.75rem;
  }
  .stack-btn[data-active="1"] {
    background: color-mix(in oklab, var(--card-color, #c7d2fe) 45%, #fff 55%);
    border-color: color-mix(in oklab, var(--card-color, #a5b4fc) 60%, #000 0%);
  }
  .card[data-in-stack="1"] .face {
    border-width: 2px;
    box-shadow: 0 6px 20px rgba(0,0,0,.12);
  }
  .card[data-highlight="1"] .face {
    outline:3px solid rgba(14,165,233,0.75);
    outline-offset:-3px;
  }
  .stack-panel {
    border:1px solid #e2e8f0; border-radius:1rem; padding:1rem; background:#f8fafc;
  }
  .stack-card {
    border-radius:.75rem; border:1px solid color-mix(in oklab, var(--card-color, #E2E8F0) 60%, #000 0%);
    background: color-mix(in oklab, var(--card-color, #F1F5F9) 30%, #fff 70%);
    padding:.75rem; display:flex; gap:.75rem; align-items:flex-start;
  }
  .stack-card button {
    border:1px solid #CBD5E1; padding:.2rem .35rem; border-radius:.35rem; font-size:.7rem;
  }
  .stack-card button:disabled { opacity:.4; cursor:not-allowed; }
  .stack-card-main { flex:1; cursor:pointer; }
  .stack-card-actions { display:flex; flex-direction:column; gap:.35rem; }
  .stack-meta { font-size:.75rem; color:#64748b; }
  .stack-empty { font-size:.85rem; color:#475569; font-style:italic; }
  .presentation-overlay {
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:rgba(15,23,42,0.75); z-index:50; padding:1.5rem;
  }
  .presentation-overlay[hidden] { display:none; }
  .presentation-dialog {
    background:#fff; border-radius:1rem; width:100%; max-width:48rem; max-height:100%;
    padding:1.5rem; box-shadow:0 20px 45px rgba(15,23,42,0.35); display:flex; flex-direction:column;
  }
  .presentation-card {
    flex:1; overflow:auto; margin-top:1rem; margin-bottom:1rem;
  }
  .presentation-controls { display:flex; gap:.75rem; justify-content:space-between; flex-wrap:wrap; }
  .presentation-face {
    border-radius:1rem;
    border:1px solid color-mix(in oklab, var(--card-color, #CBD5E1) 55%, #000 0%);
    background: color-mix(in oklab, var(--card-color, #F1F5F9) 25%, #fff 75%);
    padding:1.5rem;
    box-shadow:0 10px 35px rgba(15,23,42,0.18);
  }
</style>
</head>
<body class="bg-white text-slate-900">
  <main class="max-w-6xl mx-auto px-4 py-8">
    <header class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <h1 class="text-2xl font-semibold">Actual Deck</h1>
        <p id="meta" class="text-sm text-slate-500">Loading…</p>
      </div>

      <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
        <select id="preset" class="border rounded-lg px-3 py-2">
          <option value="">All cards</option>
        </select>
        <input id="q" type="search" placeholder="Search title, quote, tags"
               class="border rounded-lg px-3 py-2 w-full sm:w-64" />
        <button id="shuffle" class="dialog-btn">Shuffle</button>
      </div>
    </header>

    <div class="flex flex-col-reverse lg:flex-row gap-6">
      <aside class="lg:w-80 w-full">
        <div class="stack-panel lg:sticky lg:top-4 space-y-4">
          <div>
            <h2 class="text-base font-semibold">Presentation stack</h2>
            <p id="stack-meta" class="stack-meta">No cards selected yet.</p>
          </div>
          <div id="stack-list" class="space-y-3"></div>
          <div class="flex gap-2 flex-wrap">
            <button id="stack-present" class="border px-3 py-2 rounded-lg" disabled>Start presentation</button>
            <button id="stack-clear" class="border px-3 py-2 rounded-lg" disabled>Clear</button>
          </div>
        </div>
      </aside>

      <section id="cards" class="flex-1 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></section>
    </div>

    <template id="card-tpl">
      <article class="card">
        <div class="card-inner">
          <!-- FRONT -->
          <div class="face front card-surface card-front">
            <header class="card-header">
              <span class="type-ribbon" data-family-pill></span>
              <div class="card-controls">
                <button class="stack-btn" data-stack>Add to stack</button>
                <button class="flip-btn" data-flip>Flip</button>
              </div>
            </header>
            <div class="card-front-body">
              <div class="card-illustration" data-illustration></div>
              <div class="card-front-content">
                <h2 class="card-title" data-title></h2>
                <p class="card-summary" data-summary></p>
                <blockquote class="card-quote" data-quote></blockquote>
                <p class="card-author" data-author></p>
              </div>
            </div>
            <div class="mt-2 flex flex-wrap items-center gap-2 justify-between">
              <span class="type-pill" data-family-pill></span>
              <div class="flex items-center gap-2">
                <button class="stack-btn" data-stack>Add to stack</button>
                <button class="flip-btn" data-flip>Flip</button>
              </div>
            </div>
            <blockquote class="mt-3 text-slate-800 italic" data-quote></blockquote>
            <p class="mt-1 text-sm text-slate-500" data-author></p>
            <p class="mt-4 text-sm" data-body></p>
            <div class="mt-4 flex flex-wrap gap-2" data-tags></div>
          </div>

          <!-- BACK -->
          <div class="face back card-surface card-back">
            <header class="card-header">
              <span class="type-ribbon" data-family-pill-back></span>
              <button class="flip-btn" data-flip>Flip</button>
            </header>
            <h3 class="card-back-title" data-title-back></h3>
            <div class="card-back-body" data-back></div>
          </div>
        </div>
      </article>
    </template>
  </main>

  <div id="presentation" class="presentation-overlay" hidden>
    <div class="presentation-dialog" role="dialog" aria-modal="true" aria-labelledby="presentation-title">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 id="presentation-title" class="text-lg font-semibold">Presentation mode</h2>
          <p id="presentation-meta" class="stack-meta"></p>
        </div>
        <button id="presentation-close" class="border px-3 py-2 rounded-lg">Close</button>
      </div>
      <div id="presentation-card" class="presentation-card"></div>
      <div class="presentation-controls">
        <div class="flex gap-2">
          <button id="presentation-prev" class="border px-3 py-2 rounded-lg">Previous</button>
          <button id="presentation-next" class="border px-3 py-2 rounded-lg">Next</button>
        </div>
        <div class="flex gap-2">
          <button id="presentation-flip" class="border px-3 py-2 rounded-lg">Flip card</button>
        </div>
      </div>
    </div>
  </div>

<script>
  // Config
  const JSON_BASE = "/data/actual-deck";
  const CARDS_URL = `${JSON_BASE}/cards.json`;
  const PRESETS_URL = `${JSON_BASE}/presets.json`;

  // Simple color map by type/family
  const TYPE_COLORS = {
    automation: "#dbeafe",   // blue-100
    conviviality: "#bbf7d0", // green-200
    design: "#fecaca",       // red-200
    flow: "#bae6fd",         // sky-200
    language: "#fde68a",     // amber-200
    mechanism: "#e9d5ff",    // purple-200
    metric: "#fbcfe8",       // pink-200
    outcome: "#c7d2fe",      // indigo-200
    truth: "#fef3c7",        // amber-100
    vision: "#bae6e8",       // teal-200
  };
  const DEFAULT_COLOR = "#e5e7eb"; // gray-200

  // State
  let ALL_CARDS = [];
  let PRESETS = [];
  let CURRENT = [];
  let STACK = [];
  const STACK_KEY = "actualDeckStack";
  let presentationIndex = 0;
  let presentationFlipped = false;
  const highlightTimers = new Map();

  // Elements
  const elCards   = document.getElementById("cards");
  const elPreset  = document.getElementById("preset");
  const elQ       = document.getElementById("q");
  const elMeta    = document.getElementById("meta");
  const elTpl     = document.getElementById("card-tpl");
  const elShuffle = document.getElementById("shuffle");
  const elStackList   = document.getElementById("stack-list");
  const elStackMeta   = document.getElementById("stack-meta");
  const elStackPresent= document.getElementById("stack-present");
  const elStackClear  = document.getElementById("stack-clear");
  const elPresentation      = document.getElementById("presentation");
  const elPresentationMeta  = document.getElementById("presentation-meta");
  const elPresentationCard  = document.getElementById("presentation-card");
  const elPresentationPrev  = document.getElementById("presentation-prev");
  const elPresentationNext  = document.getElementById("presentation-next");
  const elPresentationFlip  = document.getElementById("presentation-flip");
  const elPresentationClose = document.getElementById("presentation-close");
  const qs = new URLSearchParams(location.search);
  const cb = Date.now();

  async function fetchJSON(url){ const r=await fetch(`${url}?cb=${cb}`); if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); }
  function normalize(s){ return (s||"").toLowerCase(); }
  function pickColor(family){
    const key = normalize(family||"");
    return TYPE_COLORS[key] || DEFAULT_COLOR;
  }
  function cardDomId(id){
    if (!id && id !== 0) return "";
    return `card-${String(id).trim().replace(/[^a-zA-Z0-9_-]+/g, "-").toLowerCase()}`;
  }
  function normalizeId(id){
    if (!id && id !== 0) return null;
    return typeof id === "string" ? id : String(id);
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function getCardById(id){
    const key = normalizeId(id);
    if (key === null) return undefined;
    return ALL_CARDS.find(c => normalizeId(c.id) === key);
  }
  function buildBackHtml(c){
    return c.back || c.notes || c.details ||
      [
        c.principle ? `<p><strong>Principle:</strong> ${escapeHtml(c.principle)}</p>` : "",
        c.context ? `<p><strong>Context:</strong> ${escapeHtml(c.context)}</p>` : "",
        c.actions?.length ? `<div><strong>Actions</strong><ul class="list-disc pl-5">${c.actions.map(a=>`<li>${escapeHtml(a)}</li>`).join("")}</ul></div>` : "",
        c.references?.length ? `<div><strong>References</strong><ul class="list-disc pl-5">${c.references.map(r=>`<li>${escapeHtml(r)}</li>`).join("")}</ul></div>` : "",
      ].filter(Boolean).join("") ||
      `<pre class="text-xs bg-white/50 p-2 rounded border">${escapeHtml(JSON.stringify(c, null, 2))}</pre>`;
  }
  function loadStack(){
    if (typeof localStorage === "undefined") return;
    try{
      const raw = localStorage.getItem(STACK_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed)){
        STACK = parsed.map(normalizeId).filter(id => id !== null);
      }
    }catch(err){
      console.warn("Failed to load stack", err);
    }
  }
  function saveStack(){
    if (typeof localStorage === "undefined") return;
    try{ localStorage.setItem(STACK_KEY, JSON.stringify(STACK)); }
    catch(err){ console.warn("Failed to save stack", err); }
  }
  function renderStack(){
    const unique = [];
    for (const id of STACK){
      if (id !== null && !unique.includes(id) && getCardById(id)) unique.push(id);
    }
    if (unique.length !== STACK.length){
      STACK = unique;
      saveStack();
    }

    elStackList.innerHTML = "";
    const hasCards = STACK.length > 0;
    elStackMeta.textContent = hasCards
      ? `Cards selected: ${STACK.length}`
      : "No cards selected yet.";
    elStackPresent.disabled = !hasCards;
    elStackClear.disabled = !hasCards;

    if (!hasCards){
      closePresentation();
      const p = document.createElement("p");
      p.className = "stack-empty";
      p.textContent = "Select cards to build your presentation stack.";
      elStackList.appendChild(p);
      return;
    }

    STACK.forEach((id, index) => {
      const storedId = id;
      const card = getCardById(storedId);
      if (!card) return;

      const item = document.createElement("div");
      item.className = "stack-card";
      const color = pickColor(card.family || card.type);
      item.style.setProperty("--card-color", color);

      const main = document.createElement("div");
      main.className = "stack-card-main";
      const title = document.createElement("p");
      title.className = "text-sm font-medium";
      title.textContent = card.title || "(untitled)";
      const meta = document.createElement("p");
      meta.className = "text-xs text-slate-500";
      const metaBits = [card.family || card.type || "unspecified", card.id].filter(Boolean);
      meta.textContent = metaBits.join(" • ");
      main.appendChild(title);
      main.appendChild(meta);

      main.addEventListener("click", () => scrollToCard(storedId));

      const actions = document.createElement("div");
      actions.className = "stack-card-actions";

      function makeBtn(label, title){
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = label;
        btn.title = title;
        btn.setAttribute("aria-label", title);
        return btn;
      }

      const presentBtn = makeBtn("▶", "Present from this card");
      presentBtn.addEventListener("click", (e) => { e.stopPropagation(); startPresentation(index); });

      const upBtn = makeBtn("↑", "Move up");
      upBtn.disabled = index === 0;
      upBtn.addEventListener("click", (e) => { e.stopPropagation(); moveStack(storedId, -1); });

      const downBtn = makeBtn("↓", "Move down");
      downBtn.disabled = index === STACK.length - 1;
      downBtn.addEventListener("click", (e) => { e.stopPropagation(); moveStack(storedId, 1); });

      const removeBtn = makeBtn("✕", "Remove from stack");
      removeBtn.addEventListener("click", (e) => { e.stopPropagation(); toggleStack(storedId); });

      actions.appendChild(presentBtn);
      actions.appendChild(upBtn);
      actions.appendChild(downBtn);
      actions.appendChild(removeBtn);

      item.appendChild(main);
      item.appendChild(actions);
      elStackList.appendChild(item);
    });

    if (!elPresentation.hasAttribute("hidden")){
      updatePresentation();
    }
  }
  function toggleStack(id){
    const key = normalizeId(id);
    if (key === null) return;
    const idx = STACK.indexOf(key);
    if (idx > -1){
      STACK.splice(idx, 1);
    }else{
      STACK.push(key);
    }
    renderStack();
    renderCards(CURRENT);
    saveStack();
  }
  function moveStack(id, dir){
    const key = normalizeId(id);
    if (key === null) return;
    const idx = STACK.indexOf(key);
    if (idx === -1) return;
    const next = idx + dir;
    if (next < 0 || next >= STACK.length) return;
    const [item] = STACK.splice(idx, 1);
    STACK.splice(next, 0, item);
    renderStack();
    saveStack();
  }
  function clearStack(){
    STACK = [];
    presentationIndex = 0;
    renderStack();
    renderCards(CURRENT);
    saveStack();
  }
  function startPresentation(index = 0){
    if (!STACK.length) return;
    presentationIndex = Math.min(Math.max(index, 0), STACK.length - 1);
    presentationFlipped = false;
    updatePresentation();
    elPresentation.removeAttribute("hidden");
    document.body.style.overflow = "hidden";
    document.addEventListener("keydown", handleKeydown);
  }
  function changePresentation(delta){
    if (!STACK.length) return;
    presentationIndex = Math.min(Math.max(presentationIndex + delta, 0), STACK.length - 1);
    presentationFlipped = false;
    updatePresentation();
  }
  function updatePresentation(){
    if (!STACK.length){
      closePresentation();
      return;
    }
    if (presentationIndex < 0) presentationIndex = 0;
    if (presentationIndex >= STACK.length) presentationIndex = STACK.length - 1;
    const id = STACK[presentationIndex];
    const card = getCardById(id);
    if (!card){
      STACK.splice(presentationIndex, 1);
      renderStack();
      saveStack();
      if (!STACK.length){
        closePresentation();
      }else{
        presentationIndex = Math.min(presentationIndex, STACK.length - 1);
        updatePresentation();
      }
      return;
    }

    const color = pickColor(card.family || card.type);
    const tagsHtml = (card.tags || []).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join(" ");
    const frontHtml = `
      <article class="presentation-face" style="--card-color:${color}">
        <div class="flex items-start justify-between gap-3">
          <h3 class="text-xl font-semibold">${escapeHtml(card.title || "(untitled)")}</h3>
          <span class="text-sm text-slate-500">${escapeHtml(card.id || "")}</span>
        </div>
        <div class="mt-2 flex items-center gap-2">
          <span class="type-pill">${escapeHtml(card.family || card.type || "unspecified")}</span>
        </div>
        ${card.quote ? `<blockquote class="mt-4 text-slate-800 italic">${escapeHtml(card.quote)}</blockquote>` : ""}
        ${card.author ? `<p class="text-sm text-slate-500">— ${escapeHtml(card.author)}</p>` : ""}
        ${card.body ? `<p class="mt-4 text-sm">${escapeHtml(card.body)}</p>` : ""}
        ${tagsHtml ? `<div class="mt-4 flex flex-wrap gap-2">${tagsHtml}</div>` : ""}
      </article>
    `;
    const backHtml = `
      <article class="presentation-face" style="--card-color:${color}">
        <div class="flex items-start justify-between gap-3">
          <h3 class="text-xl font-semibold">Back</h3>
          <span class="text-sm text-slate-500">${escapeHtml(card.id || "")}</span>
        </div>
        <div class="mt-4 text-sm space-y-3">${buildBackHtml(card)}</div>
      </article>
    `;

    elPresentationCard.innerHTML = presentationFlipped ? backHtml : frontHtml;
    elPresentationCard.scrollTop = 0;
    elPresentationMeta.textContent = `Card ${presentationIndex + 1} of ${STACK.length}`;
    elPresentationPrev.disabled = presentationIndex === 0;
    elPresentationNext.disabled = presentationIndex >= STACK.length - 1;
    elPresentationFlip.textContent = presentationFlipped ? "Show front" : "Show back";
  }
  function closePresentation(){
    elPresentation.setAttribute("hidden", "");
    presentationFlipped = false;
    document.body.style.overflow = "";
    document.removeEventListener("keydown", handleKeydown);
  }
  function handleKeydown(event){
    if (elPresentation.hasAttribute("hidden")) return;
    if (event.key === "Escape"){
      closePresentation();
    }else if (event.key === "ArrowRight" || event.key === "PageDown"){
      event.preventDefault();
      changePresentation(1);
    }else if (event.key === "ArrowLeft" || event.key === "PageUp"){
      event.preventDefault();
      changePresentation(-1);
    }else if (event.key === " " || event.key === "Spacebar"){
      event.preventDefault();
      presentationFlipped = !presentationFlipped;
      updatePresentation();
    }
  }
  function scrollToCard(id){
    const key = normalizeId(id);
    if (key === null) return;
    const domId = cardDomId(key);
    if (!domId) return;
    const cardEl = document.getElementById(domId);
    if (!cardEl) return;
    cardEl.scrollIntoView({ behavior: "smooth", block: "center" });
    cardEl.setAttribute("data-highlight", "1");
    const existing = highlightTimers.get(domId);
    if (existing) clearTimeout(existing);
    const timeout = setTimeout(() => {
      cardEl.removeAttribute("data-highlight");
      highlightTimers.delete(domId);
    }, 1600);
    highlightTimers.set(domId, timeout);
  }

  function renderCards(list){
    elCards.innerHTML = "";
    if(!list.length){ elCards.innerHTML = `<p class="text-slate-600">No cards match.</p>`; return; }

    const frag = document.createDocumentFragment();
    for(const c of list){
      const node = elTpl.content.cloneNode(true);
      const root = node.querySelector("article.card");
      const color = pickColor(c.family || c.type);
      const cardId = c.id;
      const normalizedId = normalizeId(cardId);
      root.style.setProperty("--card-color", color);
      if (normalizedId !== null){
        const domId = cardDomId(normalizedId);
        if (domId) root.id = domId;
      }
      root.removeAttribute("data-highlight");

      const inStack = normalizedId !== null ? STACK.includes(normalizedId) : false;
      root.setAttribute("data-in-stack", inStack ? "1" : "0");

      node.querySelector("[data-title]").textContent = c.title || "(untitled)";
      node.querySelector("[data-id]").textContent = cardId || cardId === 0 ? String(cardId) : "";
      node.querySelector("[data-quote]").textContent = c.quote || "";
      node.querySelector("[data-author]").textContent = c.author ? `— ${c.author}` : "";
      node.querySelector("[data-body]").textContent = c.body || "";

      const pill = node.querySelector("[data-family-pill]");
      const familyLabel = c.family || c.type || "unspecified";
      if (pill) pill.textContent = familyLabel;
      const pillBack = node.querySelector("[data-family-pill-back]");
      if (pillBack) pillBack.textContent = familyLabel;
      const backTitle = node.querySelector("[data-title-back]");
      if (backTitle) backTitle.textContent = c.title || "(untitled)";

      const illustration = node.querySelector("[data-illustration]");
      if (illustration){
        const seed = familyLabel || c.title || "?";
        illustration.textContent = seed.trim().charAt(0).toUpperCase() || "?";
        illustration.setAttribute("aria-hidden", "true");
      }

      const stackBtn = node.querySelector("[data-stack]");
      if (cardId || cardId === 0){
        stackBtn.textContent = inStack ? "Remove from stack" : "Add to stack";
        stackBtn.dataset.active = inStack ? "1" : "0";
        stackBtn.setAttribute("aria-pressed", inStack ? "true" : "false");
        stackBtn.disabled = false;
        stackBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          toggleStack(cardId);
        });
      }else{
        stackBtn.disabled = true;
        stackBtn.dataset.active = "0";
        stackBtn.setAttribute("aria-pressed", "false");
        stackBtn.textContent = "No ID";
      }

      const stackBtn = node.querySelector("[data-stack]");
      if (cardId || cardId === 0){
        stackBtn.textContent = inStack ? "Remove from stack" : "Add to stack";
        stackBtn.dataset.active = inStack ? "1" : "0";
        stackBtn.setAttribute("aria-pressed", inStack ? "true" : "false");
        stackBtn.disabled = false;
        stackBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          toggleStack(cardId);
        });
      }else{
        stackBtn.disabled = true;
        stackBtn.dataset.active = "0";
        stackBtn.setAttribute("aria-pressed", "false");
        stackBtn.textContent = "No ID";
      }

      // Tags
      const tagsWrap = node.querySelector("[data-tags]");
      tagsWrap.innerHTML = "";
      (c.tags || []).forEach(t => {
        const s = document.createElement("span");
        s.className = "tag";
        s.textContent = t;
        s.dataset.tag = t;
        s.addEventListener("click", () => { elQ.value = t; applyFilters(); });
        tagsWrap.appendChild(s);
      });
      if (tagsWrap.childElementCount){
        tagsWrap.removeAttribute("hidden");
      }else{
        tagsWrap.setAttribute("hidden", "");
      }

      const footer = node.querySelector(".card-footer");
      if (footer){
        const hasVisibleChild = Array.from(footer.children).some(child => !child.hasAttribute("hidden") && child.textContent.trim() !== "");
        if (hasVisibleChild){
          footer.removeAttribute("hidden");
        }else{
          footer.setAttribute("hidden", "");
        }
      }

      const backEl = node.querySelector("[data-back]");
      backEl.innerHTML = buildBackHtml(c);

      // Flip handlers
      node.querySelectorAll("[data-flip]").forEach(btn => {
        btn.addEventListener("click", () => {
          const flipped = root.getAttribute("data-flipped")==="1" ? "0" : "1";
          root.setAttribute("data-flipped", flipped);
        });
      });

      // Also flip by clicking anywhere on the card except links/buttons
      node.querySelector(".card-inner").addEventListener("click", (e) => {
        if (e.target.closest("button,a")) return;
        const flipped = root.getAttribute("data-flipped")==="1" ? "0" : "1";
        root.setAttribute("data-flipped", flipped);
      });

      frag.appendChild(node);
    }
    elCards.appendChild(frag);
    elMeta.textContent = `Cards: ${list.length} • Total: ${ALL_CARDS.length} • Presets: ${PRESETS.length}`;
  }

  function applyFilters(){
    const q = normalize(elQ.value);
    const presetId = elPreset.value;
    let base = [...ALL_CARDS];

    if (presetId) {
      const preset = PRESETS.find(p => p.id === presetId);
      const set = new Set((preset?.cards)||[]);
      base = base.filter(c => set.has(c.id));
    }

    if (q) {
      base = base.filter(c => {
        const hay = [
          c.title, c.quote, c.author, c.body, c.family, c.type,
          c.tagline, c.why, c.reflection,
          ...(c.how || []),
          ...(c.related || []),
          ...(c.audiences || []),
          ...(c.tags || [])
        ].map(normalize).join(" • ");
        return hay.includes(q);
      });
    }

    CURRENT = base;
    renderCards(CURRENT);

    const next = new URL(location);
    if (presetId) next.searchParams.set("preset", presetId); else next.searchParams.delete("preset");
    if (q) next.searchParams.set("q", q); else next.searchParams.delete("q");
    history.replaceState({}, "", next);
  }

  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }

  // Events
  document.getElementById("preset").addEventListener("change", applyFilters);
  document.getElementById("q").addEventListener("input", applyFilters);
  document.getElementById("shuffle").addEventListener("click", () => { shuffle(CURRENT); renderCards(CURRENT); });
  elStackPresent.addEventListener("click", () => startPresentation(0));
  elStackClear.addEventListener("click", clearStack);
  elPresentationPrev.addEventListener("click", () => changePresentation(-1));
  elPresentationNext.addEventListener("click", () => changePresentation(1));
  elPresentationFlip.addEventListener("click", () => { presentationFlipped = !presentationFlipped; updatePresentation(); });
  elPresentationClose.addEventListener("click", closePresentation);
  elPresentation.addEventListener("click", (event) => { if (event.target === elPresentation) closePresentation(); });

  // Boot
  (async function init(){
    try{
      const [cards, presets] = await Promise.all([
        fetchJSON(CARDS_URL),
        fetchJSON(PRESETS_URL).catch(()=>[])
      ]);
      ALL_CARDS = Array.isArray(cards)?cards:[];
      PRESETS = Array.isArray(presets)?presets:[];
      PRESETS.forEach(p => {
        const opt=document.createElement("option"); opt.value=p.id; opt.textContent=p.name||p.id; elPreset.appendChild(opt);
      });

      const initPreset = qs.get("preset"); const initQ = qs.get("q");
      if (initPreset) document.getElementById("preset").value = initPreset;
      if (initQ) document.getElementById("q").value = initQ;

      loadStack();
      renderStack();

      applyFilters();
    }catch(e){
      elMeta.textContent = `Error: ${e.message}`;
      elCards.innerHTML = `<p class="text-red-700">Failed to load JSON from ${JSON_BASE}.</p>`;
    }
  })();
</script>
</body>
</html>

